<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solana Wallet Connect & Send 1 SOL</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: 40px auto;
      padding: 20px;
      background: #f0f2f5;
      text-align: center;
    }
    button {
      padding: 12px 24px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #4a90e2;
      color: white;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #357abd;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      min-height: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Подключи Solana кошелек и отправь 1 SOL</h1>

  <div>
    <button id="connect-phantom">Подключить Phantom</button>
    <button id="connect-solflare">Подключить Solflare</button>
  </div>

  <div>
    <button id="send-sol" disabled>Отправить 1 SOL</button>
  </div>

  <div id="status"></div>

  <!-- Подключаем библиотеки -->
  <script src="https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-base@0.9.15/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-phantom@0.9.15/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/wallet-adapter-solflare@0.9.15/lib/index.iife.min.js"></script>

  <script>
    (async () => {
      const { Connection, clusterApiUrl, PublicKey, Transaction, SystemProgram } = solanaWeb3;
      const { PhantomWalletAdapter } = walletAdapterPhantom;
      const { SolflareWalletAdapter } = walletAdapterSolflare;

      const connection = new Connection(clusterApiUrl('mainnet-beta'), 'confirmed');

      const recipientAddress = 'DSj8cEN1Bd9CxFrrgNMuwcTnqtfJ4JKFakLeFnjDYNvR';

      const btnPhantom = document.getElementById('connect-phantom');
      const btnSolflare = document.getElementById('connect-solflare');
      const btnSend = document.getElementById('send-sol');
      const statusDiv = document.getElementById('status');

      let wallet = null;

      function setStatus(text, isError = false) {
        statusDiv.textContent = text;
        statusDiv.style.color = isError ? 'red' : 'green';
      }

      // Проверяем готовность адаптера (ждём событие ready)
      async function waitForReady(adapter) {
        if (adapter.ready) return true;
        return new Promise((resolve) => {
          adapter.on('ready', () => resolve(true));
          // Таймаут на 5 секунд
          setTimeout(() => resolve(false), 5000);
        });
      }

      async function connectWallet(adapter) {
        const ready = await waitForReady(adapter);
        if (!ready) {
          setStatus('Кошелек не доступен в браузере', true);
          return;
        }
        try {
          await adapter.connect();
          wallet = adapter;
          setStatus(`Кошелек подключен: ${wallet.publicKey.toBase58()}`);
          btnSend.disabled = false;
          btnPhantom.disabled = true;
          btnSolflare.disabled = true;
        } catch (err) {
          setStatus('Ошибка подключения: ' + err.message, true);
        }
      }

      async function sendSol() {
        if (!wallet || !wallet.connected) {
          setStatus('Сначала подключите кошелек', true);
          return;
        }
        try {
          setStatus('Формируем транзакцию...');

          const recipientPubkey = new PublicKey(recipientAddress);
          const fromPubkey = wallet.publicKey;

          const transaction = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey,
              toPubkey: recipientPubkey,
              lamports: 1_000_000_000,
            })
          );

          transaction.feePayer = fromPubkey;
          const { blockhash } = await connection.getRecentBlockhash();
          transaction.recentBlockhash = blockhash;

          const signedTx = await wallet.signTransaction(transaction);

          const txid = await connection.sendRawTransaction(signedTx.serialize());

          setStatus('Транзакция отправлена, ожидаем подтверждения...');

          await connection.confirmTransaction(txid, 'confirmed');

          setStatus(`Транзакция подтверждена! TxID: ${txid}`);
        } catch (err) {
          setStatus('Ошибка при отправке: ' + err.message, true);
        }
      }

      const phantomAdapter = new PhantomWalletAdapter();
      const solflareAdapter = new SolflareWalletAdapter();

      btnPhantom.addEventListener('click', () => connectWallet(phantomAdapter));
      btnSolflare.addEventListener('click', () => connectWallet(solflareAdapter));
      btnSend.addEventListener('click', sendSol);

      phantomAdapter.on('disconnect', () => {
        setStatus('Phantom кошелек отключен', true);
        btnSend.disabled = true;
        btnPhantom.disabled = false;
        btnSolflare.disabled = false;
        wallet = null;
      });

      solflareAdapter.on('disconnect', () => {
        setStatus('Solflare кошелек отключен', true);
        btnSend.disabled = true;
        btnPhantom.disabled = false;
        btnSolflare.disabled = false;
        wallet = null;
      });
    })();
  </script>
</body>
</html>


