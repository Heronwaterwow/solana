<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phantom Wallet Connect</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    button:hover {
      background: #357abd;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>Подключение к Phantom Wallet</h1>
  <button id="connectBtn">Подключить кошелек</button>
  <button id="transferBtn" disabled>Списать 0.01 SOL</button>
  <div id="status"></div>

  <script>
    // Проверка на мобильное устройство
    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Deeplink для открытия Phantom Wallet на мобильных
    const PHANTOM_DEEPLINK = 'https://phantom.app/ul/browse/';
    const PHANTOM_APP_LINK = 'phantom://browse/';

    // Адрес для списания SOL (замените на свой)
    const RECIPIENT_ADDRESS = '7BgBvyjrZX8YKHGoW9Y9NChumg5BNVN1r8fKSaVqNPXa';
    const TRANSFER_AMOUNT = 0.01; // 0.01 SOL

    let provider;
    let publicKey;

    // Функция для открытия Phantom Wallet
    function openPhantomWallet() {
      if (isMobile()) {
        // Открываем мобильное приложение через Deeplink
        window.location.href = PHANTOM_APP_LINK + encodeURIComponent(window.location.href);
      } else {
        // На десктопе используем API Phantom
        if (window.phantom?.solana?.isPhantom) {
          provider = window.phantom.solana;
          connectWallet();
        } else {
          // Если Phantom не установлен, предлагаем скачать
          window.open('https://phantom.app/', '_blank');
          document.getElementById('status').textContent = 'Установите Phantom Wallet для подключения';
          document.getElementById('status').className = 'error';
        }
      }
    }

    // Подключение кошелька через API Phantom
    async function connectWallet() {
      try {
        const response = await provider.connect();
        publicKey = response.publicKey.toString();
        
        document.getElementById('status').textContent = `Кошелек подключен: ${publicKey.slice(0, 4)}...${publicKey.slice(-4)}`;
        document.getElementById('status').className = 'success';
        document.getElementById('transferBtn').disabled = false;
        
        console.log('Connected to Phantom Wallet:', publicKey);
      } catch (error) {
        document.getElementById('status').textContent = 'Ошибка подключения: ' + error.message;
        document.getElementById('status').className = 'error';
      }
    }

    // Функция для списания SOL
    async function transferSol() {
      if (!publicKey) {
        document.getElementById('status').textContent = 'Сначала подключите кошелек';
        document.getElementById('status').className = 'error';
        return;
      }

      try {
        document.getElementById('status').textContent = 'Отправка транзакции...';
        document.getElementById('status').className = '';

        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
        const fromPubkey = new solanaWeb3.PublicKey(publicKey);
        const toPubkey = new solanaWeb3.PublicKey(RECIPIENT_ADDRESS);
        const lamports = solanaWeb3.LAMPORTS_PER_SOL * TRANSFER_AMOUNT;

        // Создаем транзакцию
        const transaction = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: fromPubkey,
            toPubkey: toPubkey,
            lamports: lamports
          })
        );

        // Получаем последний блокхеш
        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = fromPubkey;

        // Подписываем транзакцию через Phantom
        const signedTx = await provider.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signedTx.serialize());

        document.getElementById('status').textContent = `Транзакция успешно отправлена: ${signature}`;
        document.getElementById('status').className = 'success';

        console.log('Transaction signature:', signature);
      } catch (error) {
        document.getElementById('status').textContent = 'Ошибка: ' + error.message;
        document.getElementById('status').className = 'error';
        console.error('Transfer error:', error);
      }
    }

    // Назначение обработчиков кнопок
    document.getElementById('connectBtn').addEventListener('click', openPhantomWallet);
    document.getElementById('transferBtn').addEventListener('click', transferSol);

    // Автоматическое подключение, если Phantom уже установлен
    if (window.phantom?.solana?.isPhantom) {
      provider = window.phantom.solana;
      // Попытка автоматического подключения (если уже был подключен ранее)
      provider.connect({ onlyIfTrusted: true })
        .then(response => {
          publicKey = response.publicKey.toString();
          document.getElementById('status').textContent = `Автоподключение: ${publicKey.slice(0, 4)}...${publicKey.slice(-4)}`;
          document.getElementById('status').className = 'success';
          document.getElementById('transferBtn').disabled = false;
        })
        .catch(() => {
          // Игнорируем ошибку, если пользователь еще не подключался
        });
    }
  </script>
</body>
</html>
